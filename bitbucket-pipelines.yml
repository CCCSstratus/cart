
pipelines:
  default:
    - parallel: &default_tests
        - step:
            name: Build & Test 2.7.6
            image: gbrowdy/python-2.7.6
            script: &build_test
              - python setup.py sdist
              - pip install -f dist cart
              - python -m unittest discover
        - step:
            name: Build & Test 2.7
            image: python:2.7
            script: *build_test
        - step:
            name: Build & Test 3.3
            image: python:3.3
            script: *build_test
        - step:
            name: Build & Test 3.4
            image: python:3.4
            script: *build_test
        - step:
            name: Build & Test 3.5
            image: python:3.5
            script: *build_test
        - step:
            name: Build & Test 3.6
            image: python:3.6
            script: *build_test
        - step:
            name: Build & Test 3.7-rc
            image: python:3.7-rc
            script: *build_test
  tags:
    v*:
      - parallel: *default_tests
      - step:
          name: Deploy to Test PyPI
          image: python:3.6
          trigger: manual
          deployment: test
          script:
            - pip install twine wheel
            - python setup.py sdist
            - python setup.py bdist_wheel --universal
            - ls dist
            - twine upload --repository-url $TEST_REPOSITORY_URL dist/*
          artifacts:
            - dist/*
      - step:
          name: Deploy to PyPI
          image: python:3.6
          trigger: manual
          deployment: production
          script:
            - pip install twine wheel
            - python setup.py sdist
            - python setup.py bdist_wheel --universal
            - ls dist
            - twine upload dist/*
          artifacts:
            - dist/*
